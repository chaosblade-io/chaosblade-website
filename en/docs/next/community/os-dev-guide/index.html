<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-community/os-dev-guide">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">OS Scenario Extension Development Documentation | ChaosBlade</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:image" content="https://chaosblade.io/en/img/cb-logo.png"><meta data-rh="true" name="twitter:image" content="https://chaosblade.io/en/img/cb-logo.png"><meta data-rh="true" property="og:url" content="https://chaosblade.io/en/docs/next/community/os-dev-guide"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="OS Scenario Extension Development Documentation | ChaosBlade"><meta data-rh="true" name="description" content="chaosblade-exec-os is a basic resource scenario project, such as CPU, memory, process, network, disk and other system resource basic scenarios. This article introduces the basic resource scenario extension in detail from four aspects: project engineering, execution process, scenario extension, and packaging test."><meta data-rh="true" property="og:description" content="chaosblade-exec-os is a basic resource scenario project, such as CPU, memory, process, network, disk and other system resource basic scenarios. This article introduces the basic resource scenario extension in detail from four aspects: project engineering, execution process, scenario extension, and packaging test."><link data-rh="true" rel="icon" href="/en/img/favicon/favicon.ico"><link data-rh="true" rel="canonical" href="https://chaosblade.io/en/docs/next/community/os-dev-guide"><link data-rh="true" rel="alternate" href="https://chaosblade.io/en/docs/next/community/os-dev-guide" hreflang="en"><link data-rh="true" rel="alternate" href="https://chaosblade.io/docs/next/community/os-dev-guide" hreflang="zh"><link data-rh="true" rel="alternate" href="https://chaosblade.io/docs/next/community/os-dev-guide" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://AJZLJ48ZRO-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="ChaosBlade RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="ChaosBlade Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FY5W27B8XH"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-FY5W27B8XH",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ChaosBlade" href="/en/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&display=block">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=block">
<script src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/en/assets/css/styles.1d896bee.css">
<link rel="preload" href="/en/assets/js/runtime~main.160e28c5.js" as="script">
<link rel="preload" href="/en/assets/js/main.c3218017.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️  &nbsp; If you like ChaosBlade, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/chaosblade-io/chaosblade">GitHub</a>! ⭐️</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/cb-head.png" alt="ChaosBlade" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/cb-head.png" alt="ChaosBlade" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ChaosBlade</b></a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/en/docs/next/">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/en/docs/next/community/os-dev-guide">Next</a></li><li><a class="dropdown__link" href="/en/docs/community/os-dev-guide">1.7.0</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/docs">Documentation</a><a class="navbar__item navbar__link" href="/en/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/chaosblade-io/chaosblade" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-githab-link"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/en/docs/next/community/os-dev-guide" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/docs/next/community/os-dev-guide" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">简体中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/next/">About ChaosBlade</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/next/getting-started/platform-box-quick-start">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/en/docs/next/community/docs">Community</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/next/community/docs">Contribute documents</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/next/community/PR-guide">PR Submission Guidelines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/next/community/dev-standard">Development standard</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/next/community/os-dev-guide">OS Scenario Extension Development Documentation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/next/community/issue-standard">Issue submission and handling specifications</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/next/experiment-types/host/blade create cpu load">Types of Chaos Experiments</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->ChaosBlade<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/en/docs/community/os-dev-guide">latest version</a></b> (<!-- -->1.7.0<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Community</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">OS Scenario Extension Development Documentation</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: Next</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>OS Scenario Extension Development Documentation</h1><p><a href="https://github.com/chaosblade-io/chaosblade-exec-os" target="_blank" rel="noopener noreferrer">chaosblade-exec-os</a> is a basic resource scenario project, such as CPU, memory, process, network, disk and other system resource basic scenarios. This article introduces the basic resource scenario extension in detail from four aspects: project engineering, execution process, scenario extension, and packaging test.</p><h1>Project Structure</h1><p><img loading="lazy" src="https://alidocs.oss-accelerate.aliyuncs.com/res/a4jKqmxykw8Ynw19/img/90ef69c6-6c2f-4989-ba8b-1be56686372b.png" alt="image" class="img_ev3q"></p><p>The code of this project consists of four parts:</p><ol><li><p>build is a cross-platform packaging directory.</p></li><li><p>exec is the implementation code of each scenario.</p></li><li><p>extra is a dependent third-party tool.</p></li><li><p>main.go is the scene execution entry.</p></li></ol><h1>Execution Flow</h1><p><img loading="lazy" src="https://alidocs.oss-accelerate.aliyuncs.com/res/a4jKqmxykw8Ynw19/img/aed33af9-3670-4428-9a41-e67676247303.png" alt="image" class="img_ev3q"></p><ol><li><p>Executing the basic resource scene through blade will call <code>bin/chaos_os</code> file to run.</p></li><li><p><code>bin/chaos_os</code> will parse the command parameters to identify whether to create an experiment or destroy an experiment.</p></li><li><p>Convert experiment parameters to experiment model object.</p></li><li><p>Call the corresponding experiment executor to execute.</p></li></ol><h1>Scenario Extension</h1><p>This article takes three new scenarios of Linux system shutdown, power off, and reboot as examples to introduce in detail how to expand the system scenarios in the chaosblade-exec-os project.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scenario-realization-design">Scenario Realization Design<a class="hash-link" href="#scenario-realization-design" title="Direct link to heading">​</a></h2><p>After investigation, in Linux, the host can be shut down (halt), power-off (power-off) and rebooted (reboot) through the shutdown command. You can view the command details through the shutdown command help document. The relevant commands are as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># The system will shut down after 1 minute, if no time is added, the default is to execute after 1 minute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shutdown -H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># The system powers off immediately</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shutdown -P now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># The system is forced to restart after 2 minutes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shutdown -r -f +2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cancel the shutdown command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shutdown -c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Mapping with the ChaosBlade chaos engineering experimental model, shutdown can be used as the target, halt, poweroff, and reboot can be used as the action respectively, and the forced operation force and time parameter setting are supported. Note that in order to be more suitable for users, the time parameter needs to be modified. If this parameter is not filled in, it means that it will be executed immediately, and the default value will be changed to now. Then use chaosblade to execute as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># The system shuts down after 1 minute, if no time is added, the default is to execute immediately</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blade create shutdown halt --time 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># The system powers off immediately</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blade create shutdown poweroff --force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># The system is forced to restart after 2 minutes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blade create shutdown reboot --time 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#Cancel the shutdown command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blade destroy UID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scenario-code-implementation">Scenario Code Implementation<a class="hash-link" href="#scenario-code-implementation" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-reference">Case Reference<a class="hash-link" href="#case-reference" title="Direct link to heading">​</a></h3><p>The extended failure scenario is similar to the process failure scenario, such as killing a process and stopping a process, which can be realized by referring to the process scenario.</p><p><img loading="lazy" src="https://alidocs.oss-accelerate.aliyuncs.com/res/a4jKqmxykw8Ynw19/img/9f6ac3fe-5c55-42b0-874b-1d44b05e36e8.png" alt="image" class="img_ev3q"></p><p>It can be seen from the existing process scene code that in the exec directory, create a process directory to define the target is the process failure scene model definition <code>ProcessCommandModelSpec</code>, in this model respectively define the kill process kill scene and stop process stop scene experimental action model NewXXXProcessActionCommandSpec, Each scenario is defined in <code>process_kill.go</code> and <code>process_stop.go</code> respectively.
Taking KillProcessActionCommandSpec as an example, the following content needs to be defined mainly according to <code>BaseExpActionCommandSpec</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Fault Scenario Matching Conditions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionMatchers    []ExpFlagSpec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Fault related parameters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionFlags       []ExpFlagSpec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Failure Scenario Executor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionExecutor    Executor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Long description of the failure scenario</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionLongDesc    string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Failure Scenario Use Cases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionExample     string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// The executor used by the failure scenario execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionPrograms    []string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Failure scene directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionCategories  []string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Whether the daemon runs persistently in the fault scenario</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionProcessHang bool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following will introduce in detail from the creation of the Shutdown fault experiment command, to the realization of the restart experiment scenario, to the realization of the shutdown experiment scenario, to the extraction of the same implementation, and to the expansion of the power outage experiment scenario.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-shutdown-fault-command">Create a shutdown fault command<a class="hash-link" href="#create-a-shutdown-fault-command" title="Direct link to heading">​</a></h3><p>Create a shutdown directory in the exec directory to store scene-related codes, and create a shutdown.go file to define the experimental scene model.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/chaosblade-io/chaosblade-spec-go/spec&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type ShutdownCommandModelSpec struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec.BaseExpModelCommandSpec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewShutdownCommandModelSpec() spec.ExpModelCommandSpec {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &amp;ShutdownCommandModelSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spec.BaseExpModelCommandSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ExpActions: []spec.ExpActionCommandSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 重启、关机、断电实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ExpFlags: []spec.ExpFlagSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 通用参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (s ShutdownCommandModelSpec) Name() string {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;shutdown&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (s ShutdownCommandModelSpec) ShortDesc() string {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;Support shutdown, halt or reboot experiment.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (s ShutdownCommandModelSpec) LongDesc() string {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;Support shutdown, halt or reboot experiment. Can control shutdown or restart behavior with different flags. Warning! the experiment cannot be recovered by this tool.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, you need to create reboot, shutdown, and power-off related scenarios in ExpActions, and then take the restart scenario as an example</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="implement-the-reboot-scenario">Implement the reboot scenario<a class="hash-link" href="#implement-the-reboot-scenario" title="Direct link to heading">​</a></h3><p>Create <code>shutdown_reboot.go</code> file, follow <code>spec.ExpActionCommandSpec</code> definition <code>RebootActionCommandSpec</code> implementation.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type RebootActionCommandSpec struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec.BaseExpActionCommandSpec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewRebootActionCommandSpec() spec.ExpActionCommandSpec {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &amp;RebootActionCommandSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spec.BaseExpActionCommandSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ActionMatchers: []spec.ExpFlagSpec{},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ActionFlags:    []spec.ExpFlagSpec{},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ActionExecutor: &amp;RebootExecutor{},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ActionExample: `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Force to reboot machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blade c shutdown reboot --force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Reboot machine after 1 minute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blade c shutdown reboot --time 1`,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ActionPrograms:    []string{},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ActionCategories:  []string{},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ActionProcessHang: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (r *RebootActionCommandSpec) Name() string {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;reboot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (r *RebootActionCommandSpec) Aliases() []string {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return []string{&quot;s&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (r *RebootActionCommandSpec) ShortDesc() string {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;Reboot machine&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (r *RebootActionCommandSpec) LongDesc() string {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;Reboot machine. Warning! the experiment cannot be recovered by this tool.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type RebootExecutor struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    channel spec.Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (r *RebootExecutor) Name() string {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;reboot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (r *RebootExecutor) Exec(uid string, ctx context.Context, model *spec.ExpModel) *spec.Response {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // TODO 重启具体实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (r *RebootExecutor) SetChannel(channel spec.Channel) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r.channel = channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>According to the above scenario design section, use the system shutdown command to implement the machine reboot operation, and support time and enforcement parameters. It is coded and implemented in the Exec function.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (r *RebootExecutor) Exec(uid string, ctx context.Context, model *spec.ExpModel) *spec.Response {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Use it to identify operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if _, ok := spec.IsDestroy(ctx); ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return cancel(ctx, uid, model, r.channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return execute(ctx, model, &quot;-r&quot;, r.channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Execute shutdown command </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func execute(ctx context.Context, model *spec.ExpModel, command string, channel spec.Channel) *spec.Response {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response := checkShutdownCommand(channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if !response.Success {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    force := model.ActionFlags[Force.Name] == &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time := model.ActionFlags[Time.Name]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if time == &quot;&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time = &quot;now&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command = fmt.Sprintf(&quot;%s %s&quot;, ShutdownCommand, command)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if force {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        command = fmt.Sprintf(&quot;%s -f&quot;, command)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command = fmt.Sprintf(&quot;sleep %d &amp;&amp; %s %s&quot;, SleepTime, command, time)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shutdownErrLog := util.GetNohupOutput(util.Bin, stderrLog)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  nohup bash -c &quot;sleep 3 &amp;&amp; shutdown -k&quot; &lt; /dev/null &gt;/dev/null 2&gt; shutdown.err &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command = fmt.Sprintf(&quot;bash -c &#x27;%s&#x27; &lt; /dev/null &gt; /dev/null 2&gt; %s&quot;, command, shutdownErrLog)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return channel.Run(ctx, &quot;nohup&quot;, command)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Cancel shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func cancel(ctx context.Context, uid string, model *spec.ExpModel, channel spec.Channel) *spec.Response {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time := model.ActionFlags[Time.Name]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if time == &quot;&quot; || time == &quot;now&quot; || time == &quot;+0&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return spec.ReturnSuccess(uid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Calling the cancel command directly will not process the execution result.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Because the return may fail due to downtime, it returns success directly.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response := channel.Run(ctx, ShutdownCommand, &quot;-c&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if !response.Success {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logrus.Warningf(&quot;uid: %s, shutdown cancel failed, %v&quot;, uid, response.Error())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Not bug.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return spec.ReturnSuccess(uid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After the restart scenario is implemented, this scenario can be added to the shutdown command:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func NewShutdownCommandModelSpec() spec.ExpModelCommandSpec {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &amp;ShutdownCommandModelSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spec.BaseExpModelCommandSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ExpActions: []spec.ExpActionCommandSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                NewRebootActionCommandSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ExpFlags: []spec.ExpFlagSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;Time, &amp;Force,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>shutdown_halt.go</code> and <code>shutdown_poweroff.go</code> implementations can also be added in this way. Since the shutdown command controls shutdown, power-off, and reboot operations through parameters, the general code can be extracted into the shutdown.go file, and other scene files can call the functions in this file. The final code is as follows:</p><p><img loading="lazy" src="https://alidocs.oss-accelerate.aliyuncs.com/res/a4jKqmxykw8Ynw19/img/b183f750-a3d9-4063-b1c3-c1b1520a3184.png" alt="image" class="img_ev3q"></p><p>shutdown_halt.go codes：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (h *HaltExecutor) Exec(uid string, ctx context.Context, model *spec.ExpModel) *spec.Response {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, ok := spec.IsDestroy(ctx); ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return cancel(ctx, uid, model, h.channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return execute(ctx, model, &quot;-H&quot;, h.channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>shutdown_poweroff.go codes：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (p *PowerOffExecutor) Exec(uid string, ctx context.Context, model *spec.ExpModel) *spec.Response {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, ok := spec.IsDestroy(ctx); ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return cancel(ctx, uid, model, p.channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return execute(ctx, model, &quot;-P&quot;, p.channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>shutdown_reboot.go codes：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (r *RebootExecutor) Exec(uid string, ctx context.Context, model *spec.ExpModel) *spec.Response {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, ok := spec.IsDestroy(ctx); ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return cancel(ctx, uid, model, r.channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return execute(ctx, model, &quot;-r&quot;, r.channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So far, the shutdown, power-off, and restart experiment scenarios involved in shutdown have been realized, just register to the model_linux.go experiment list:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func GetAllExpModels() []spec.ExpModelCommandSpec {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return []spec.ExpModelCommandSpec{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cpu.NewCpuCommandModelSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mem.NewMemCommandModelSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        process.NewProcessCommandModelSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        network.NewNetworkCommandSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disk.NewDiskCommandSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        script.NewScriptCommandModelSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file.NewFileCommandSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kernel.NewKernelInjectCommandSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        systemd.NewSystemdCommandModelSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stressng.NewStressModelSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time.NewTimeCommandSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shutdown.NewShutdownCommandModelSpec(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Package Test</h1><p>Use make build in the project root directory to compile. After compilation, chaos_os will be generated in target/chaosblade-VERSION/bin and chaosblade-os-spec-XXX.yaml files will be generated in target/chaosblade-VERSION/yaml. In this file There will be a shutdown scenario statement:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- target: shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shortDesc: Support shutdown, halt or reboot experiment.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  longDesc: Support shutdown, halt or reboot experiment. Can control shutdown or restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    behavior with different flags. Warning! the experiment cannot be recovered by</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this tool.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - action: halt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aliases: [h]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shortDesc: Halt machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    longDesc: Halt machine. Warning! the experiment cannot be recovered by this tool.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flags:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      desc: waiting time, unit is minute, for example +1 means after 1 minute to run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      noArgs: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      required: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      requiredWhenDestroyed: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      desc: Force operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      noArgs: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      required: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      requiredWhenDestroyed: false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>测试</h1><p>Directly replace the above compiled file with the corresponding file in the original chaosblade toolkit and test it.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./blade c shutdown -h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Support shutdown, halt or reboot experiment. Can control shutdown or restart behavior with different flags. Warning! the experiment cannot be recovered by this tool.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blade create shutdown [flags]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blade create shutdown [command]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Available Commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  halt        Halt machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  poweroff    Shutdown machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  reboot      Reboot machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flags:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -h, --help   help for shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Global Flags:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -a, --async             whether to create asynchronously, default is false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d, --debug             Set client to DEBUG mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -e, --endpoint string   the create result reporting address. It takes effect only when the async value is true and the value is not empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -n, --nohup             used to internal async create, no need to config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --uid string        Set Uid for the experiment, adapt to docker and cri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Use &quot;blade create shutdown [command] --help&quot; for more information about a command.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/chaosblade-io/chaosblade-website/edit/master/docs/community/os-dev-guide.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/next/community/dev-standard"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Development standard</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/next/community/issue-standard"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Issue submission and handling specifications</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#scenario-realization-design" class="table-of-contents__link toc-highlight">Scenario Realization Design</a></li><li><a href="#scenario-code-implementation" class="table-of-contents__link toc-highlight">Scenario Code Implementation</a><ul><li><a href="#case-reference" class="table-of-contents__link toc-highlight">Case Reference</a></li><li><a href="#create-a-shutdown-fault-command" class="table-of-contents__link toc-highlight">Create a shutdown fault command</a></li><li><a href="#implement-the-reboot-scenario" class="table-of-contents__link toc-highlight">Implement the reboot scenario</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/docs">About ChaosBlade</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/community/docs">Contribute documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://gitter.im/chaosblade-io/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/chaosblade.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/chaosblade-io/shared_invite/zt-f0d3r3f4-TDK13Wr3QRUrAhems28p1w" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/en/">DingTalk(23177705)</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.netlify.com"><img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://cncf.io/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/en/img/cncf-white.svg" alt="CNCF" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/en/img/cncf-white.svg" alt="CNCF" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">© 2023 The ChaosBlade Authors. All rights reserved. <br>
            The Linux Foundation has registered trademarks and uses trademarks.
            For a list of trademarks of The Linux Foundation,
            please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.160e28c5.js"></script>
<script src="/en/assets/js/main.c3218017.js"></script>
</body>
</html>